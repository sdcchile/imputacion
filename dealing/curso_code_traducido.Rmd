---
title: "Dealing With Missing Data in R"
date: "22/2/2023"
output:
  html_document:
    theme: paper
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(naniar)
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
```

# Descripción del taller

El taller ofrecido por el Instituto Nacional de Estadísticas de Chile (INE) se centrará en la importancia de manejar y analizar datos faltantes, que son una realidad en cualquier análisis de datos del mundo real. Los valores faltantes pueden aparecer por diversas razones, desde problemas de medición hasta problemas de calidad de los datos, y su presencia puede dificultar la comprensión y la interpretación de los análisis.

En este contexto, el taller del INE brinda a los participantes las habilidades y herramientas necesarias para manejar los datos faltantes de manera efectiva y mejorar la calidad de sus análisis. En particular, se utiliza el paquete R de `naniar`, una herramienta muy útil para explorar, visualizar y manejar valores faltantes en R.

El taller consta de varios capítulos, cada uno enfocado en un aspecto específico del manejo de datos faltantes. En el primer capítulo se aprende a detectar, contar y resumir la falta de datos, utilizando técnicas como la función `is.na()` y las funciones de resumen como `sum()`, `mean()`, entre otras. Además, se enseña cómo explorar los patrones de datos faltantes en diferentes variables y casos, y cómo detectar posibles sesgos y patrones subyacentes en los datos.

En los capítulos siguientes, se aborda la imputación de valores faltantes, es decir, cómo llenar los vacíos en los datos utilizando diferentes técnicas de imputación, como la imputación por media, la imputación múltiple y la regresión de los valores faltantes. También se aprende a evaluar la calidad de los datos imputados y a tomar decisiones basadas en estos conjuntos de datos imputados.

Además, el taller incluye una sección dedicada a la visualización de datos faltantes, donde se aprende a producir visualizaciones generales para todo el conjunto de datos y para las variables, casos y otros resúmenes, y cómo explorar estos en los grupos.

En resumen, el taller del INE proporciona las habilidades y herramientas necesarias para manejar, explorar y analizar datos faltantes de manera efectiva y mejorar la calidad de los análisis de datos del mundo real.

#Capitulo 1 

## Introducción a los datos perdidos


<iframe src="https://inechile-my.sharepoint.com/personal/jibustosm_ine_gob_cl/_layouts/15/embed.aspx?UniqueId=14747496-eacf-4e05-8217-763bc043e9dd&embed=%7B%22ust%22%3Atrue%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=OneUpFileViewer&referrerScenario=EmbedDialog.Create" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen title="cap1_s1.mp4"></iframe>



## Trasncripción

1. Introducción a los datos faltantes
Para este taller se utilizarán herramientas como `tidyverse` y el paquete R de `naniar` para enseñar a manejar y analizar datos faltantes de manera efectiva. El paquete `naniar` es una herramienta muy útil para explorar, visualizar y manejar valores faltantes en R.

2. Introducción
La estadística Gertrude Mary Cox dijo una vez: "Lo mejor que se puede hacer con los datos faltantes es no tener ninguno". Si bien esto es cierto, no es el mundo en el que vivimos. Trabajar con datos del mundo real significa trabajar con datos faltantes. Para ser un gran analista, necesitas saber cómo lidiar con los valores faltantes. Comprender cómo funcionan los datos faltantes es importante, ya que pueden tener efectos inesperados en tu análisis. Por ejemplo, ajustar un modelo lineal en datos con valores faltantes elimina fragmentos de datos. Esto significa que tus decisiones no se basan en la evidencia correcta. Reemplazar los valores faltantes, lo que se llama imputación, debe hacerse con mucho cuidado, ya que insertar solo la media puede llevar a estimaciones y decisiones deficientes.

3. ¿Qué aprenderás?
En este taller aprenderás sobre qué son los valores faltantes, cómo encontrar datos faltantes, cómo manipular y limpiar datos faltantes, por qué faltan datos y cómo imputar valores faltantes.

4. Conocimientos previos
Para este taller, asumiré que tienes experiencia básica a intermedia con R, experiencia en la creación de gráficos utilizando `ggplot2`, experiencia en el uso de `dplyr` para manipular datos y experiencia en ajustar modelos lineales en R. En este primer capítulo, presentamos los valores faltantes y cómo verificarlos y contarlos.

5. ¿Qué son los valores faltantes?
Antes de comenzar, debemos definir los valores faltantes. Los valores faltantes son valores que deberían haberse registrado, pero no lo fueron. Piensa en esto de esta manera: puedes no haber registrado accidentalmente que viste un pájaro, esto es un valor faltante. Esto es diferente a registrar que no se observaron pájaros. R almacena los valores faltantes como `NA`, que significa no disponible.

6. ¿Cómo puedo verificar si tengo valores faltantes?
Los valores faltantes no saltan y gritan "¡Estoy aquí!". Por lo general, están ocultos, como una aguja en un pajar. Para detectar valores faltantes, usa `any_na`, que devuelve `TRUE` si hay valores faltantes y `FALSE` si no los hay. `are_na` pregunta "¿son estos `NA`?" y devuelve `TRUE/FALSE` para cada valor. are_na nos muestra 3 valores `TRUE`, que corresponden a 3 valores faltantes. Para evitar contar cada `TRUE` manualmente, `n_miss` cuenta el número de valores faltantes. Y `prop_miss` proporciona la proporción de valores faltantes, lo que proporciona un contexto importante: ¡el 50% de los datos está faltando!

7. Trabajando con datos faltantes
¿Qué sucede cuando mezclamos valores faltantes con nuestros cálculos? Necesitamos saber qué sucede para poder estar preparados para encontrar estos casos. La regla general es: Los cálculos con `NA` devuelven `NA`. Digamos que tienes la altura de tres amigos: Sophie, Dan y Fred. La suma de sus alturas devuelve `NA`, esto se debe a que no conocemos la suma de un número y `NA`.

8. Trampas con datos faltantes
Hay algunas "trampas" que debes tener en cuenta al trabajar con datos faltantes: Por ejemplo, `NaN` significa "Not a Number" (No es un número) y se obtiene de operaciones como la raíz cuadrada de -1. R interpreta `NaN` como un valor faltante. `NULL` es un valor vacío pero no es faltante. Esto es sutilmente diferente de los valores faltantes: un cubo vacío no tiene agua faltante. `Inf` es un valor infinito, y se obtiene de ecuaciones como 10 dividido por 0 y no es faltante.

9. Trampas con datos faltantes (2)
Por último, ten cuidado con las declaraciones condicionales con valores faltantes. Por ejemplo, `NA` o `TRUE` es `TRUE`. `NA` o `FALSE` es `NA`. `NA` `+` `NaN` es `NA`. `NaN` `+` `NA` es `NaN`.

¡Practiquemos!
¡Practiquemos!

##Usando y encontrando valores faltantes

Al trabajar con datos faltantes, hay algunos comandos con los que deberías estar familiarizado - en primer lugar, debes poder identificar si hay valores faltantes y dónde se encuentran.

Usando las herramientas `any_na()` y `are_na()`, identifica qué valores faltan.


```{r}
# Create x, a vector, with values NA, NaN, Inf, ".", and "missing"
x <- c(NA, NaN,Inf, ".", "missing")

# Use any_na() and are_na() on to explore the missings
any_na(x)
are_na(x)

```



###¿Cuántos valores faltantes hay?

Una de las primeras cosas que desearás comprobar en un nuevo conjunto de datos es si existen valores faltantes y cuántos hay.

Podrías usar `are_na()` y contar los valores faltantes, pero la forma más eficiente de contarlos es usar la función `n_miss()`. Esto te dirá el número total de valores faltantes en los datos.

Luego puedes encontrar el porcentaje de valores faltantes en los datos con la función `pct_miss`. Esto te dirá el porcentaje de valores faltantes en los datos.

También puedes encontrar el complemento de estos valores, cuántos valores completos hay, usando `n_complete` y `pct_complete`.


```{r}
# Using the example dataframe of heights and weights dat_hw
dat_hw <- read.table("~/edi_imp/datacamp_JB/dealing/dat_hw.txt", h=T,  dec=".")
```



```{r}
# Use n_miss() to count the total number of missing values in dat_hw
naniar::n_miss(dat_hw)

# Use n_miss() on dat_hw$weight to count the total number of missing values
naniar::n_miss(dat_hw$weight)

# Use n_complete() on dat_hw to count the total number of complete values
n_complete(dat_hw)

# Use n_complete() on dat_hw$weight to count the total number of complete values
n_complete(dat_hw$weight)

# Use prop_miss() and prop_complete() on dat_hw to count the total number of missing values in each of the variables
prop_miss(dat_hw)
prop_complete(dat_hw)
```

## Como resumir valores perdidos

<iframe src="https://inechile-my.sharepoint.com/personal/jibustosm_ine_gob_cl/_layouts/15/embed.aspx?UniqueId=a5a50f8d-616e-4aff-82ea-6f725f2ab09a&embed=%7B%22ust%22%3Atrue%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=OneUpFileViewer&referrerScenario=EmbedDialog.Create" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen title="cap1_s2.mp4"></iframe>

###Resumiendo la ausencia de datos

Ahora que comprendes el comportamiento de los valores faltantes en R y cómo contarlos, escalaremos nuestros resúmenes para casos (filas) y variables, utilizando `miss_var_summary()` y `miss_case_summary()`, y también exploraremos cómo se pueden aplicar a grupos en un dataframe utilizando la función `group_by` de `dplyr`.

```{r}
# Summarise missingness in each variable of the `airquality` dataset
miss_var_summary(airquality)


# Summarise missingness in each case of the `airquality` dataset
miss_case_summary(airquality)
```

```{r}
# Return the summary of missingness in each variable, grouped by Month, in the `airquality` dataset
airquality %>% group_by(Month) %>% miss_var_summary()

# Return the summary of missingness in each case, grouped by Month, in the `airquality` dataset
airquality %>% group_by(Month) %>% miss_case_summary()
```

###Tabulando los valores faltantes

Las sumarizaciones de los valores faltantes que acabamos de calcular nos dan el número y el porcentaje de observaciones faltantes para los casos y variables.

Otra manera de resumir los valores faltantes es mediante la tabulación del número de veces que hay 0, 1, 2, 3, valores faltantes en una variable o en un caso.

En este ejercicio, vamos a tabular el número de valores faltantes en cada caso y variable utilizando `miss_var_table()` y `miss_case_table()`, y también combinaremos estos resúmenes con el operador `group_by` de `dplyr` para explorar los resúmenes sobre una variable de agrupación en el conjunto de datos.

```{r}
# Tabulate missingness in each variable and case of the `airquality` dataset
miss_case_table(airquality)
miss_var_table(airquality)

# Tabulate the missingness in each variable, grouped by Month, in the `airquality` dataset
airquality %>% group_by(Month) %>% miss_var_table()

# Tabulate of missingness in each case, grouped by Month, in the `airquality` dataset
airquality %>% group_by(Month) %>% miss_case_table()
```

###Otros resúmenes de valores faltantes

Algunos resúmenes de valores faltantes son particularmente útiles para diferentes tipos de datos. Por ejemplo, `miss_var_span()` y `miss_var_run()`.

`miss_var_span()` calcula el número de valores faltantes en una variable especificada para un intervalo repetido. Esto es muy útil en datos de series de tiempo, para buscar patrones de valores faltantes semanales (de 7 días).

`miss_var_run()` calcula el número de "rachas" o "cadenas" de valores faltantes. Esto es útil para encontrar patrones inusuales de valores faltantes, por ejemplo, podría encontrar un patrón repetitivo de 5 completos y 5 faltantes.

Tanto `miss_var_span()` como `miss_var_run()` funcionan con el operador `group_by` de `dplyr`.


```{r}
# Calculate the summaries for each run of missingness for the variable, hourly_counts
miss_var_run(pedestrian, var = hourly_counts)

# Calculate the summaries for each span of missingness, for a span of 4000, for the variable hourly_counts
miss_var_span(pedestrian, var = hourly_counts, span_every = 4000)

# For each `month` variable, calculate the run of missingness for hourly_counts
pedestrian %>% group_by(month) %>% miss_var_run(var = hourly_counts)


# For each `month` variable, calculate the span of missingness of a span of 2000, for the variable hourly_counts
pedestrian %>% group_by(month) %>% miss_var_span(var = hourly_counts, span_every = 2000)
```

## Como podemos visualizar los valores perdidos?

<iframe src="https://inechile-my.sharepoint.com/personal/jibustosm_ine_gob_cl/_layouts/15/embed.aspx?UniqueId=1a05874a-9f8b-44bc-a3bb-23f87d61a56d&embed=%7B%22ust%22%3Atrue%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=OneUpFileViewer&referrerScenario=EmbedDialog.Create" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen title="cap1_s3.mp4"></iframe>

###Sus primeras visualizaciones de datos faltantes

Puede resultar difícil determinar dónde están los valores faltantes en sus datos, y aquí es donde la visualización realmente puede ayudar.

La función `vis_miss()` crea una visualización general de la falta de datos en los datos. También tiene opciones para agrupar filas según la falta de datos, usando `cluster = TRUE`; así como opciones para ordenar las columnas, desde las más faltantes hasta las menos faltantes (`sort_miss = TRUE`).

```{r}
# Visualize all of the missingness in the `riskfactors`  dataset
vis_miss(riskfactors)
```

```{r}
# Visualize and cluster all of the missingness in the `riskfactors` dataset
vis_miss(riskfactors, cluster  = TRUE)
```

```{r}
# visualise and sort the columns by missingness in the `riskfactors` dataset
vis_miss(riskfactors, sort_miss  = TRUE)
```

###Visualización de casos y variables faltantes

Para obtener una imagen clara de los valores faltantes en las variables y casos, utiliza `gg_miss_var()` y `gg_miss_case()`. Estas son las versiones visuales de `miss_var_summary()` y `miss_case_summary()`.

Estos pueden dividirse en múltiples gráficos, uno para cada categoría, eligiendo una variable para segmentar por ella.

```{r}
# Visualize the number of missings in cases using `gg_miss_case()`
gg_miss_case(riskfactors)
```

```{r}
# Explore the number of missings in cases using `gg_miss_case()` and facet by the variable `education`
gg_miss_case(riskfactors, facet = education)
```

```{r}
# Visualize the number of missings in variables using `gg_miss_var()`
gg_miss_var(riskfactors)
```

```{r}
# Explore the number of missings in variables using `gg_miss_var()` and facet by the variable `education`
gg_miss_var(riskfactors, facet = education)
```

##Visualizando patrones de datos faltantes

Practiquemos algunas formas diferentes de visualizar patrones de datos faltantes usando:

`gg_miss_upset()` para mostrar un patrón general de datos faltantes.
`gg_miss_fct()` para un conjunto de datos que tiene un factor de interés: el matrimonio.
y `gg_miss_span()` para explorar los datos faltantes en un conjunto de datos de series de tiempo.
¿Qué notas sobre los datos faltantes y la segmentación en los datos?

```{r}
# Using the airquality dataset, explore the missingness pattern using gg_miss_upset()
gg_miss_upset(airquality)
```

```{r}
# With the riskfactors dataset, explore how the missingness changes across the marital variable using gg_miss_fct()
gg_miss_fct(x = riskfactors, fct = marital)
```

```{r}
# Using the pedestrian dataset, explore how the missingness of hourly_counts changes over a span of 3000 
gg_miss_span(pedestrian, var = hourly_counts, span_every = 3000)
```

```{r}
# Using the pedestrian dataset, explore the impact of month by facetting by month
# and explore how missingness changes for a span of 1000
gg_miss_span(pedestrian, var = hourly_counts , span_every = 1000, facet = month)
```

#Limpieza y organización de valores faltantes

En el capítulo dos, aprenderás cómo descubrir valores faltantes ocultos como "missing" o "N/A" y reemplazarlos con `NA`. Aprenderás cómo manejar de manera eficiente los valores faltantes implícitos: aquellos valores que se dan por sentados como faltantes pero que no se enumeran explícitamente. También cubriremos cómo explorar la dependencia de datos faltantes, discutiendo Missing Completely at Random (MCAR), Missing At Random (MAR), Missing Not At Random (MNAR) y lo que significan para el análisis de tus datos.

##Búsqueda y reemplazo de valores faltantes

<iframe src="https://inechile-my.sharepoint.com/personal/jibustosm_ine_gob_cl/_layouts/15/embed.aspx?UniqueId=00826590-b373-43bf-ac09-d1a0b8857f71&embed=%7B%22ust%22%3Atrue%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=OneUpFileViewer&referrerScenario=EmbedDialog.Create" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen title="cap2_s1.mp4"></iframe>


###Usando miss_scan_count

Tienes un conjunto de datos con valores faltantes codificados como `"N/A"`, `"missing"` y `"na"`. Pero antes de seguir adelante y comenzar a reemplazarlos con `NA`, deberíamos tener una idea de qué tan grande es el problema.

Utiliza `miss_scan_count` para contar los valores faltantes posibles en el conjunto de datos `pacman`, que contiene tres columnas:

`year`: el año en que la persona obtuvo esa puntuación.
`initial`: las iniciales de la persona.
`score`: las puntuaciones de esa persona.

```{r}
# Using the example dataframe
pacman<-readRDS("~/edi_imp/datacamp_JB/dealing/pacman.rds")
```



```{r}
# Explore the strange missing values "N/A"
miss_scan_count(data = pacman, search = list("N/A"))
```

```{r}
# Explore the strange missing values "missing"
miss_scan_count(data = pacman, search = list("missing"))
```

```{r}
# Explore the strange missing values "na"
miss_scan_count(data = pacman, search = list("na"))
```

```{r}
# Explore the strange missing values " " (a single space)
miss_scan_count(data = pacman, search = list(" "))
```

```{r}
# Explore all of the strange missing values, "N/A", "missing", "na", " "
miss_scan_count(data = pacman, search = list("N/A", "missing","na", " "))
```


###Usando replace_with_na

Siguiendo con el conjunto de datos anterior, ahora sabemos que tenemos algunos valores faltantes extraños.

Ahora, vamos a hacer algo al respecto y reemplazar estos valores con valores faltantes (por ejemplo, `NA`) usando la función `replace_with_na()`.

```{r}
# Print the top of the pacman data using `head()`
head(pacman)

# Replace the strange missing values "N/A", "na", and 
# "missing" with `NA` for the variables, year, and score
pacman_clean <- replace_with_na(pacman, replace = list(year = c("N/A", "na", "missing"),
                                score = c("N/A", "na", "missing")))
                                        
# Test if `pacman_clean` still has these values in it?
miss_scan_count(pacman_clean, search = list("N/A", "na", "missing"))
```

###Usando las variantes "scoped" de replace_with_na

Para reducir la repetición de código al reemplazar valores con `NA`, utiliza las variantes "scoped" de `replace_with_na()`:

`replace_with_na_at()`
`replace_with_na_if()`
`replace_with_na_all()`

La sintaxis de reemplazo se ve así:

`~.x == "N/A"`
Esto reemplaza todos los casos que son iguales a `"N/A"`.

`~.x %in% c("N/A", "missing", "na", " ")`
Reemplaza todos los casos que tienen `"N/A"`, `"missing"`, `"na"` o `" "`.


```{r}
# Use `replace_with_na_at()` to replace with NA
replace_with_na_at(pacman,
                   .vars = c("year", "month", "day"), 
                   ~.x %in% c("N/A", "missing", "na", " "))

# Use `replace_with_na_if()` to replace with NA the character values using `is.character`
replace_with_na_if(pacman,
                   .predicate = is.character, 
                   ~.x %in% c("N/A", "missing", "na", " "))

# Use `replace_with_na_all()` to replace with NA
replace_with_na_all(pacman, ~.x %in% c("N/A", "missing", "na", " "))
```

##Rellenando valores faltantes hacia abajo (cap2_s2)

<iframe src="https://inechile-my.sharepoint.com/personal/jibustosm_ine_gob_cl/_layouts/15/embed.aspx?UniqueId=be562f67-a4b0-4c11-80a8-5d9b8acf96b9&embed=%7B%22ust%22%3Atrue%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=OneUpFileViewer&referrerScenario=EmbedDialog.Create" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen title="cap2_s2.mp4"></iframe>



###Arreglando valores faltantes implícitos usando complete()

Vamos a explorar un nuevo conjunto de datos, frogger.

Este conjunto de datos contiene 4 puntuaciones por jugador registradas en diferentes momentos: `morning`, `afternoon`, `evening` y `late_night`.

Cada jugador debería haber jugado 4 partidas, una en cada uno de estos momentos, pero parece que no todos los jugadores completaron todos estos juegos.

Utiliza la función `complete()` para hacer explícitos estos valores faltantes implícitos.


```{r}
frogger <- read_excel("~/edi_imp/datacamp_JB/dealing/frogger.xlsx")
```


```{r}
# Print the frogger data to have a look at it
frogger

# Use `complete()` on the `time` and `name` variables to  
# make implicit missing values explicit
frogger_tidy <- frogger %>% complete(time, name)
```
###Arreglando valores faltantes explícitos usando fill()

Un tipo de valor faltante que puede ser obvio de tratar es donde se da la primera entrada de un grupo, pero las entradas subsiguientes están marcadas como `NA`.

Estos valores faltantes a menudo son el resultado de valores vacíos en hojas de cálculo para evitar ingresar múltiples nombres varias veces; así como para "legibilidad humana".

Este tipo de problema se puede resolver utilizando la función `fill()` del paquete `tidyr`.

```{r}
# Print the frogger data to have a look at it
frogger

# Use `fill()` to fill down the name variable in the frogger dataset
frogger %>% fill(name)
```

###Usando complete() y fill() juntos

¡Ahora pongámoslo todo junto!

Utiliza `complete()` y `fill()` juntos para corregir valores faltantes explícitos e implícitos en el conjunto de datos frogger.

```{r}
# Print the frogger data to have a look at it
frogger

# Correctly fill() and complete() missing values so that our dataset becomes sensible
frogger %>%
  fill(name) %>%
  complete(name, time)
```

##Dependencia de datos faltantes

<iframe src="https://inechile-my.sharepoint.com/personal/jibustosm_ine_gob_cl/_layouts/15/embed.aspx?UniqueId=287bf9a7-ebd3-4f6c-ae90-a84d29de3608&embed=%7B%22ust%22%3Atrue%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=OneUpFileViewer&referrerScenario=EmbedDialog.Create" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen title="cap2_s3.mp4"></iframe>

###Diferencias entre MCAR y MAR

Necesitamos hacer ciertas suposiciones sobre nuestros datos cuando avanzamos en el análisis.

¿Cuál de las siguientes respuestas sobre MCAR y MAR es VERDADERA?

##Posibles respuestas

*En general, eliminar observaciones es más seguro para datos MCAR que eliminar observaciones para datos MAR. *

MCAR significa que la falta de datos está relacionada con los datos observados, mientras que para MAR, la falta de datos está relacionada con los datos no observados.

MAR y MCAR son efectivamente lo mismo, la distinción no es importante.

**Los datos MCAR no están relacionados con los datos observados y no observados.**
**Los datos MAR están relacionados con los datos observados.**

###Explorando la dependencia de datos faltantes

Para aprender sobre la estructura de la falta de datos en los datos, puedes explorar cómo cambia la presentación de la falta de datos al ordenar los datos.

Para el conjunto de datos `oceanbuoys`, explora la falta de datos con `vis_miss()` y luego ordénalo por algunas variables diferentes.

Este no es un proceso definitivo, pero te ayudará a comenzar a hacer las preguntas correctas sobre tus datos. Exploramos técnicas más poderosas en el próximo capítulo.

```{r}
# Arrange by year
oceanbuoys %>% arrange(year) %>% vis_miss()

# Arrange by latitude
oceanbuoys %>% arrange(latitude) %>% vis_miss()

# Arrange by wind_ew (wind east west)
oceanbuoys %>% arrange(wind_ew) %>% vis_miss()
```

###Explorando aún más la dependencia de los datos faltantes

Usando la información previa sobre el conjunto de datos `oceanbuoys`, ¿cuál de estas afirmaciones es la más apropiada sobre el tipo de datos faltantes?

Intenta usar `gg_miss_var()` y `gg_miss_case()`, agrupando por año para obtener más información. Por ejemplo:

`library(naniar) gg_miss_var(oceanbuoys, facet = year)`

Posibles respuestas:

Los datos son MCAR: la dirección del viento es importante para explicar los datos faltantes.

Los datos son MCAR: el año es importante para explicar los datos faltantes.

Los datos son MAR: la ubicación no es importante para explicar los datos faltantes.

*Los datos son MAR: tanto el año como la ubicación son importantes para explicar los datos faltantes.*

#Capítulo 2

##Herramientas para explorar la dependencia de los datos faltantes

<iframe src="https://inechile-my.sharepoint.com/personal/jibustosm_ine_gob_cl/_layouts/15/embed.aspx?UniqueId=edbedf86-e40c-4a31-9fc0-b3245b93f79b&embed=%7B%22ust%22%3Atrue%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=OneUpFileViewer&referrerScenario=EmbedDialog.Create" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen title="cap3_s1.mp4"></iframe>


###Creando datos de matriz de sombra

Los datos faltantes pueden ser complicados de pensar, ya que normalmente no se proclaman por sí mismos y en su lugar se esconden entre la maleza de los datos.

Una forma de ayudar a exponer los valores faltantes es cambiar la forma en que pensamos sobre los datos, pensando en cada valor de datos como faltante o no faltante.

La función `as_shadow()` en R transforma un dataframe en una matriz de sombra, un formato de datos especial donde los valores son o bien faltantes (`NA`) o no faltantes (`!NA`).

Los nombres de columna de una matriz de sombra son los mismos que los datos, pero tienen un sufijo agregado `_NA`.

Para realizar un seguimiento y comparar los valores de los datos con su estado de falta, use la función `bind_shadow()`. Tener los datos en este formato, con la columna de matriz de sombra unida a los datos regulares, se llama datos `nabular`.


```{r}
# Create shadow matrix data with `as_shadow()`
as_shadow(oceanbuoys)

# Create nabular data by binding the shadow to the data with `bind_shadow()`
bind_shadow(oceanbuoys)

# Bind only the variables with missing values by using bind_shadow(only_miss = TRUE)
bind_shadow(oceanbuoys, only_miss = TRUE)
```

###Realizando resúmenes agrupados de valores faltantes

Ahora que puedes crear datos nabulares, vamos a utilizarlos para explorar los datos. Vamos a calcular estadísticas de resumen basadas en los valores faltantes de otra variable.

Para hacer esto, vamos a seguir los siguientes pasos:

Primero, `bind_shadow()` convierte los datos en datos nabulares.

A continuación, realiza algunos resúmenes en los datos utilizando `group_by()` y `summarize()` para calcular la media y la desviación estándar, utilizando las funciones `mean()` y `sd()`.


```{r}
# `bind_shadow()` and `group_by()` humidity missingness (`humidity_NA`)
oceanbuoys %>%
  bind_shadow() %>%
  group_by(humidity_NA) %>%
  summarize(wind_ew_mean = mean(wind_ew), # calculate mean of wind_ew
            wind_ew_sd = sd(wind_ew)) # calculate standard deviation of wind_ew
  
# Repeat this, but calculating summaries for wind north south (`wind_ns`)
oceanbuoys %>%
  bind_shadow() %>%
  group_by(humidity_NA) %>%
  summarize(wind_ns_mean = mean(wind_ns),
            wind_ns_sd = sd(wind_ns))
```

##Explorando combinaciones adicionales de valores faltantes

Puede ser útil obtener un poco de información adicional sobre el número de casos en cada condición de valores faltantes.

En este ejercicio, vamos a añadir información sobre el número de casos observados utilizando `n()` dentro de la función `summarize()`.

Luego añadiremos un nivel adicional de agrupamiento al examinar la combinación de humedad faltante (`humidity_NA`) y temperatura del aire faltante (`air_temp_c_NA`).

```{r}
# Summarize wind_ew by the missingness of `air_temp_c_NA`
oceanbuoys %>% 
  bind_shadow() %>%
  group_by(air_temp_c_NA) %>%
  summarize(wind_ew_mean = mean(wind_ew),
            wind_ew_sd = sd(wind_ew),
            n_obs = n())

# Summarize wind_ew by missingness of `air_temp_c_NA` and `humidity_NA`
oceanbuoys %>% 
  bind_shadow() %>%
  group_by(air_temp_c_NA, humidity_NA) %>%
  summarize(wind_ew_mean = mean(wind_ew),
            wind_ew_sd = sd(wind_ew),
            n_obs = n())
```

##Visualizando los valores faltantes de una variable

<iframe src="https://inechile-my.sharepoint.com/personal/jibustosm_ine_gob_cl/_layouts/15/embed.aspx?UniqueId=3c8ffb3c-d7df-46de-a8e2-4325f7986649&embed=%7B%22ust%22%3Atrue%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=OneUpFileViewer&referrerScenario=EmbedDialog.Create" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen title="cap3_s2.mp4"></iframe>


###Datos nabulares y llenado por valores faltantes

Los estadísticos de resumen son útiles para calcular, pero como dicen, una imagen vale más que mil palabras.

En este ejercicio, vamos a explorar cómo puedes utilizar datos `nabular` para explorar la variación en una variable según los valores faltantes de otra.

Vamos a utilizar el conjunto de datos `oceanbuoys` de `naniar`.

```{r}
# First explore the missingness structure of `oceanbuoys` using `vis_miss()`
vis_miss(oceanbuoys)

# Explore the distribution of `wind_ew` for the missingness  
# of `air_temp_c_NA` using  `geom_density()`
bind_shadow(oceanbuoys) %>%
  ggplot(aes(x = wind_ew, 
             color = air_temp_c_NA)) + 
  geom_density()

# Explore the distribution of sea temperature for the  
# missingness of humidity (humidity_NA) using  `geom_density()`
bind_shadow(oceanbuoys) %>%
  ggplot(aes(x = sea_temp_c,
             color = humidity_NA)) + 
  geom_density()
```

Ahora puedes utilizar datos nabulares para visualizar y explorar datos faltantes utilizando gráficos de densidad.

###Datos nabulares y resumen por valores faltantes

En este ejercicio, vamos a explorar cómo utilizar datos `nabular` para explorar la variación en una variable según los valores faltantes de otra.

Vamos a utilizar el conjunto de datos `oceanbuoys` de `naniar`, y luego crear múltiples gráficos de los datos utilizando facetas.

Esto te permite explorar diferentes capas de valores faltantes.

```{r}
# Explore the distribution of wind east west (wind_ew) for the missingness of air temperature 
# using geom_density() and faceting by the missingness of air temperature (air_temp_c_NA).
oceanbuoys %>%
  bind_shadow() %>%
  ggplot(aes(x = wind_ew)) + 
  geom_density() + 
  facet_wrap(~air_temp_c_NA)

# Build upon this visualization by filling by the missingness of humidity (humidity_NA).
oceanbuoys %>%
  bind_shadow() %>%
  ggplot(aes(x = wind_ew,
             color = humidity_NA)) + 
  geom_density() + 
  facet_wrap(~air_temp_c_NA)
```

Ahora puedes utilizar datos nabulares para visualizar y explorar datos faltantes.

###Explorar variación por valores faltantes: gráficos de caja

Los ejercicios anteriores utilizan datos `nabular` junto con gráficos de densidad para explorar la variación en una variable según los valores faltantes de otra.

Vamos a utilizar el conjunto de datos `oceanbuoys` de `naniar`, utilizando gráficos de caja en lugar de facetas u otros para explorar diferentes capas de valores faltantes.

```{r}
# Explore the distribution of wind east west (`wind_ew`) for  
# the missingness of air temperature using  `geom_boxplot()`
oceanbuoys %>%
  bind_shadow() %>%
  ggplot(aes(x = air_temp_c_NA,
             y = wind_ew)) + 
  geom_boxplot()

# Build upon this visualization by faceting by the missingness of humidity (`humidity_NA`).
oceanbuoys %>%
  bind_shadow() %>%
  ggplot(aes(x = air_temp_c_NA,
             y = wind_ew)) + 
  geom_boxplot() + 
  facet_wrap(~humidity_NA)
```
Ahora puedes utilizar datos nabulares para visualizar y explorar datos faltantes con gráficos de caja y envolturas de facetas.

##Visualizar valores faltantes en dos variables

<iframe src="https://inechile-my.sharepoint.com/personal/jibustosm_ine_gob_cl/_layouts/15/embed.aspx?UniqueId=15bcb041-7ed5-4c1f-99bf-a19d161aedc8&embed=%7B%22ust%22%3Atrue%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=OneUpFileViewer&referrerScenario=EmbedDialog.Create" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen title="cap3_s3.mp4"></iframe>

###Explorando datos faltantes con gráficos de dispersión

Los valores faltantes en un gráfico de dispersión en `ggplot2` se eliminan por defecto, con una advertencia.

Podemos mostrar los valores faltantes en un gráfico de dispersión utilizando `geom_miss_point()` - una geometría especial de `ggplot2` que desplaza los valores faltantes dentro del gráfico, mostrándolos un 10% por debajo del mínimo de la variable.

Practiquemos esta visualización con el conjunto de datos `oceanbuoys`.

```{r}
# Explore the missingness in wind and air temperature, and  
# display the missingness using `geom_miss_point()`
ggplot(oceanbuoys,
       aes(x = wind_ew,
           y = air_temp_c)) + 
  geom_miss_point()

# Explore the missingness in humidity and air temperature,  
# and display the missingness using `geom_miss_point()`
ggplot(oceanbuoys,
       aes(x = humidity,
           y = air_temp_c)) + 
  geom_miss_point()
```

###Usando facetas para explorar valores faltantes

Debido a que `geom_miss_point()` es una geometría de ggplot, puedes usarla con características de `ggplot2` como el uso de facetas.

Esto significa que podemos explorar rápidamente los valores faltantes y permanecer dentro de los límites familiares de `ggplot2`.

```{r}
# Explore the missingness in wind and air temperature, and display the 
# missingness using `geom_miss_point()`. Facet by year to explore this further.
ggplot(oceanbuoys,
       aes(x = wind_ew,
           y = air_temp_c)) + 
  geom_miss_point() + 
  facet_wrap(~year)

# Explore the missingness in humidity and air temperature, and display the 
# missingness using `geom_miss_point()` Facet by year to explore this further.
ggplot(oceanbuoys,
       aes(x = humidity,
           y = air_temp_c)) + 
  geom_miss_point() + 
  facet_wrap(~year)
```

Ahora puedes usar `geom_miss_point()` para explorar valores faltantes en un gráfico de dispersión y puedes usar facetas para expandir y explorar aún más.

###Facetas para explorar valores faltantes (múltiples gráficos)
Otra técnica útil con `geom_miss_point()` es explorar los valores faltantes creando múltiples gráficos.

Así como lo hemos hecho en ejercicios anteriores, podemos usar los datos nabulares para ayudarnos a crear gráficos facetados adicionales.

Incluso podemos crear múltiples gráficos facetados según los valores en los datos, como el año, y las características de los datos, como la falta de valores.

```{r}
# Use geom_miss_point() and facet_wrap to explore how the missingness 
# in wind_ew and air_temp_c is different for missingness of humidity
bind_shadow(oceanbuoys) %>%
  ggplot(aes(x = wind_ew,
           y = air_temp_c)) + 
  geom_miss_point() + 
  facet_wrap(~humidity_NA)

# Use geom_miss_point() and facet_grid to explore how the missingness in wind_ew and air_temp_c 
# is different for missingness of humidity AND by year - by using `facet_grid(humidity_NA ~ year)`
bind_shadow(oceanbuoys) %>%
  ggplot(aes(x = wind_ew,
             y = air_temp_c)) + 
  geom_miss_point() + 
  facet_grid(humidity_NA~year)
```

##Realizando y rastreando imputaciones.

<iframe src="https://inechile-my.sharepoint.com/personal/jibustosm_ine_gob_cl/_layouts/15/embed.aspx?UniqueId=47e7bac5-15e3-4467-bce6-f9379c30298f&embed=%7B%22ust%22%3Atrue%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=OneUpFileViewer&referrerScenario=EmbedDialog.Create" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen title="cap3_s4.mp4"></iframe>

###Imputar datos por debajo del rango con datos nulos.
Queremos hacer un seguimiento de los valores que imputamos. Si no lo hacemos, es muy difícil evaluar qué tan buenos son los valores imputados.

Vamos a practicar imputando datos y recreando visualizaciones en el conjunto de ejercicios anterior mediante la imputación de valores por debajo del rango de los datos.

Esta es una forma muy útil de ayudar a explorar aún más la falta de datos y también proporciona el marco para imputar valores faltantes.

Primero, vamos a imputar los datos por debajo del rango usando `impute_below_all()`, y luego visualizar los datos. Notamos que aunque podemos ver dónde están los valores faltantes en este caso, necesitamos alguna forma de hacer un seguimiento de ellos. El patrón de programación de seguimiento de datos faltantes puede ayudar con esto.

```{r}
# Impute the data below the range using `impute_below`.
ocean_imp <- impute_below_all(oceanbuoys)

# Visualize the new missing values
ggplot(ocean_imp,
       aes(x = wind_ew, y = air_temp_c)) + 
  geom_point()

# Impute and track data with `bind_shadow`, `impute_below`, and `add_label_shadow`
ocean_imp_track <- bind_shadow(oceanbuoys) %>% 
  impute_below_all() %>%
  add_label_shadow()

# Look at the imputed values
ocean_imp_track
```

###Visualizar valores imputados en un gráfico de dispersión.

Ahora, vamos a recrear uno de los gráficos anteriores que vimos en el capítulo tres que utilizaba `geom_miss_point()`.

Para hacer esto, necesitamos imputar los datos por debajo del rango de los datos. Esta es una imputación especial para explorar los datos. Esta imputación ilustrará lo que necesitamos practicar: cómo hacer un seguimiento de los valores faltantes. Para imputar los datos por debajo del rango de los datos, usamos la función `impute_below_all()`.

```{r}
# Impute and track the missing values
ocean_imp_track <- bind_shadow(oceanbuoys) %>% 
  impute_below_all() %>%
  add_label_shadow()

# Visualize the missingness in wind and air temperature,  
# coloring missing air temp values with air_temp_c_NA
ggplot(ocean_imp_track,
       aes(x = wind_ew, y = air_temp_c, color = air_temp_c_NA)) + 
  geom_point()

# Visualize humidity and air temp, coloring any missing cases using the variable any_missing
ggplot(ocean_imp_track,
       aes(x = humidity, y = air_temp_c, color = any_missing)) + 
  geom_point()
```

###Crear un histograma de los datos imputados.

Ahora que podemos recrear la primera visualización de `geom_miss_point()`, vamos a explorar cómo podemos aplicar esto a otras tareas exploratorias.

Una tarea útil es evaluar el número de valores faltantes en una variable dada usando un histograma. Podemos hacer esto usando el conjunto de datos `ocean_imp_track` que creamos en el último ejercicio, el cual está cargado en esta sesión.

```{r}
# Explore the values of air_temp_c, visualizing the amount of missings with `air_temp_c_NA`.
p <- ggplot(ocean_imp_track, aes(x = air_temp_c, fill = air_temp_c_NA)) + geom_histogram()

# Expore the missings in humidity using humidity_NA
p2 <- ggplot(ocean_imp_track, aes(x = humidity, fill = humidity_NA)) + geom_histogram()

# Explore the missings in air_temp_c according to year, using `facet_wrap(~year)`.
p + facet_wrap(~year)

# Explore the missings in humidity according to year, using `facet_wrap(~year)`.
p2 + facet_wrap(~year)
```

## ¿Qué hace una buena imputación?

<iframe src="https://inechile-my.sharepoint.com/personal/jibustosm_ine_gob_cl/_layouts/15/embed.aspx?UniqueId=8abdba7b-a326-4908-b0fa-0afc56babb9c&embed=%7B%22ust%22%3Atrue%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=OneUpFileViewer&referrerScenario=EmbedDialog.Create" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen title="cap4_s1.mp4"></iframe>

###Evaluando imputaciones malas.

Para evaluar imputaciones, es útil saber cómo se ve algo malo. Para explorar esto, veamos un método de imputación típicamente malo: imputar usando el valor promedio.

En este ejercicio vamos a explorar cómo funciona el método de imputación de promedio usando un diagrama de caja, utilizando el conjunto de datos `oceanbuoys`.

```{r}
# Impute the mean value and track the imputations 
ocean_imp_mean <- bind_shadow(oceanbuoys) %>% 
  impute_mean_all() %>% 
  add_label_shadow()

# Explore the mean values in humidity in the imputed dataset
ggplot(ocean_imp_mean, 
       aes(x = humidity_NA, y = humidity)) + 
  geom_boxplot()

# Explore the values in air temperature in the imputed dataset
ggplot(ocean_imp_mean, 
       aes(x = air_temp_c_NA, y = air_temp_c)) + 
  geom_boxplot()
```
### Evaluating imputations: The scale

Si bien la imputación de la media puede no parecer tan mala cuando la comparamos mediante un diagrama de caja, es importante tener una idea de la variación en los datos. Es por eso que es importante explorar cómo cambia la escala y la dispersión de los valores imputados en comparación con los datos.

Una forma de evaluar la adecuación de la escala de las imputaciones es usar un gráfico de dispersión para explorar si los valores son apropiados o no.

```{r}
# Explore imputations in air temperature and humidity,  
# coloring by the variable, any_missing
ggplot(ocean_imp_mean, 
       aes(x = air_temp_c, y = humidity, color = any_missing)) + 
  geom_point()

# Explore imputations in air temperature and humidity,  
# coloring by the variable, any_missing, and faceting by year
ggplot(ocean_imp_mean, 
       aes(x = air_temp_c, y = humidity, color = any_missing)) +
  geom_point() + 
  facet_wrap(~year)
```
###Evaluando imputaciones: en muchas variables.

Hasta ahora, hemos cubierto formas de ver las variables individuales o pares de variables y sus valores imputados. Sin embargo, a veces deseamos ver las imputaciones para muchas variables. Para hacer esto, es necesario realizar algún tratamiento de datos y reorganización. Esta lección cubre cómo realizar este procesamiento de datos, que puede ser un poco complicado cuando se considera su uso en datos `nabular`. La función `shadow_long()` coloca los datos en la forma adecuada para este tipo de visualizaciones.

```{r}
# Gather the imputed data 
ocean_imp_mean_gather <- shadow_long(ocean_imp_mean,
                                     humidity,
                                     air_temp_c)
# Inspect the data
ocean_imp_mean_gather
ocean_imp_mean_gather$value<-as.numeric(ocean_imp_mean_gather$value)


# Explore the imputations in a histogram 
ggplot(ocean_imp_mean_gather, 
       aes(x = value, fill = value_NA)) + 
  geom_histogram() + 
  facet_wrap(~variable)
```

## Realizando imputaciones.

<iframe src="https://inechile-my.sharepoint.com/personal/jibustosm_ine_gob_cl/_layouts/15/embed.aspx?UniqueId=77f2cf92-5026-4118-86d1-d8ae031075b7&embed=%7B%22ust%22%3Atrue%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=OneUpFileViewer&referrerScenario=EmbedDialog.Create" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen title="cap4_s2.mp4"></iframe>


###Utilizando simputation para imputar datos.

Existen muchos paquetes de imputación en R. Nos enfocaremos en usar el paquete `simputation`, que proporciona una interfaz simple y potente para realizar imputaciones.

Construir un buen modelo de imputación es muy importante, pero es un tema complejo: hay tanto para construir un buen modelo de imputación como para construir un buen modelo estadístico. En este taller, nos enfocaremos en cómo evaluar las imputaciones.

Primero, vamos a ver cómo utilizar la función `impute_lm()`, que imputa valores de acuerdo a un modelo lineal especificado.

En este ejercicio, vamos a aplicar las técnicas de evaluación anteriores a los datos con `impute_lm()`, y luego construir sobre este método de imputación en lecciones posteriores.

```{r}
library(simputation)
# Impute humidity and air temperature using wind_ew and wind_ns, and track missing values
ocean_imp_lm_wind <- oceanbuoys %>% 
    bind_shadow() %>%
    impute_lm(air_temp_c ~ wind_ew + wind_ns) %>% 
    impute_lm(humidity ~ wind_ew + wind_ns) %>%
    add_label_shadow()
    
# Plot the imputed values for air_temp_c and humidity, colored by missingness
ggplot(ocean_imp_lm_wind, 
       aes(x = air_temp_c, y = humidity, color = any_missing)) +
  geom_point()
```
### Evaluando y comparando imputaciones

Cuando se construye un modelo de imputación, es una buena idea compararlo con otro método. En esta lección, vamos a comparar el conjunto de datos previamente imputados creado utilizando `impute_lm()` con el conjunto de datos imputados con la media. Ambos conjuntos de datos están incluidos en este ejercicio como `ocean_imp_lm_wind` y `ocean_imp_mean`, respectivamente.


```{r}
# Bind the models together 
bound_models <- bind_rows(mean = ocean_imp_mean,
                          lm_wind = ocean_imp_lm_wind,
                          .id = "imp_model")

# Inspect the values of air_temp and humidity as a scatter plot
ggplot(bound_models,
       aes(x = air_temp_c,
           y = humidity,
           color = any_missing)) +
  geom_point() + 
  facet_wrap(~imp_model)
```
### Evaluando imputaciones (muchos modelos y variables)

Cuando se construye un modelo de imputación, es una buena idea compararlo con otro método.

En esta lección, se te pedirá que agregues un modelo de imputación final que contenga una pieza adicional de información útil que ayude a explicar parte de la variación en los datos. Luego, compararás los valores, como se hizo anteriormente en la última lección.

```{r}
# Build a model adding year to the outcome
ocean_imp_lm_wind_year <- bind_shadow(oceanbuoys) %>%
  impute_lm(air_temp_c ~ wind_ew + wind_ns + year) %>%
  impute_lm(humidity ~ wind_ew + wind_ns + year) %>%
  add_label_shadow()

# Bind the mean, lm_wind, and lm_wind_year models together
bound_models <- bind_rows(mean = ocean_imp_mean,
                          lm_wind = ocean_imp_lm_wind,
                          lm_wind_year = ocean_imp_lm_wind_year,
                          .id = "imp_model")

# Explore air_temp and humidity, coloring by any missings, and faceting by imputation model
ggplot(bound_models, aes(x = air_temp_c, y = humidity, color = any_missing)) +
  geom_point() + facet_wrap(~imp_model)
```

## Evaluando imputaciones y modelos

<iframe src="https://inechile-my.sharepoint.com/personal/jibustosm_ine_gob_cl/_layouts/15/embed.aspx?UniqueId=1f6a60f8-d290-40bc-b90a-09dec8513b12&embed=%7B%22ust%22%3Atrue%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=OneUpFileViewer&referrerScenario=EmbedDialog.Create" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen title="cap4_s3.mp4"></iframe>

###Combinación y comparación de muchos modelos de imputación

Para evaluar los diferentes métodos de imputación, necesitamos ponerlos en un único dataframe. A continuación, compararás tres enfoques diferentes para manejar los datos faltantes utilizando el conjunto de datos `oceanbuoys`.

El primer método es utilizar solo los casos completados y se carga como `ocean_cc`.
El segundo método es imputar valores utilizando un modelo lineal con predicciones hechas con wind y se carga como `ocean_imp_lm_wind`.
Crearás el tercer conjunto de datos imputados, `ocean_imp_lm_all`, utilizando un modelo lineal e imputando las variables `sea_temp_c`, `air_temp_c` y `humidity` utilizando las variables `wind_ew`, `wind_ns`, `year`, `latitude` y `longitude`.

Luego unirás todos los conjuntos de datos (`ocean_cc`, `ocean_imp_lm_wind` y `ocean_imp_lm_all`), llamándolo `bound_models`.


```{r}
ocean_cc<-oceanbuoys %>%
na.omit() %>%
bind_shadow %>%
add_label_shadow()
```



```{r}
# Create an imputed dataset using a linear models
ocean_imp_lm_all <- bind_shadow(oceanbuoys) %>%
  add_label_shadow() %>%
  impute_lm(sea_temp_c ~ wind_ew + wind_ns + year + latitude + longitude) %>%
  impute_lm(air_temp_c ~ wind_ew + wind_ns + year + latitude + longitude) %>%
  impute_lm(humidity ~ wind_ew + wind_ns + year + latitude + longitude)

# Bind the datasets
bound_models <- bind_rows(cc = ocean_cc,
                          imp_lm_wind = ocean_imp_lm_wind,
                          imp_lm_all = ocean_imp_lm_all,
                          .id = "imp_model")

# Look at the models
bound_models
```

### Evaluando los diferentes parámetros en el modelo
stamos imputando nuestros datos por una razón: ¡queremos analizar los datos!

En este ejemplo, estamos interesados en predecir la temperatura del mar, así que vamos a construir un modelo lineal que prediga la temperatura del mar.

Ajustaremos este modelo a cada uno de los conjuntos de datos que creamos y luego exploraremos los coeficientes en los datos.

Los objetos de la lección anterior (`ocean_cc`, `ocean_imp_lm_wind`, `ocean_imp_lm_all` y `bound_models`) se cargan en el espacio de trabajo.

```{r}
# Create the model summary for each dataset
model_summary <- bound_models %>% 
  group_by(imp_model) %>%
  nest() %>%
  mutate(mod = purrr::map(data, ~lm(sea_temp_c ~ air_temp_c + humidity + year, data = .)),
         res = purrr::map(mod, residuals),
         pred = purrr::map(mod, predict),
         tidy = purrr::map(mod, broom::tidy))

# Explore the coefficients in the model
model_summary %>% 
    select(imp_model,tidy) %>%
	unnest()

best_model <- "imp_lm_all"
```

<iframe src="https://inechile-my.sharepoint.com/personal/jibustosm_ine_gob_cl/_layouts/15/embed.aspx?UniqueId=ccf8153b-ce55-4cbd-b57c-4811283846af&embed=%7B%22ust%22%3Atrue%2C%22hv%22%3A%22CopyEmbedCode%22%7D&referrer=OneUpFileViewer&referrerScenario=EmbedDialog.Create" width="640" height="360" frameborder="0" scrolling="no" allowfullscreen title="cap4_s4.mp4"></iframe>
